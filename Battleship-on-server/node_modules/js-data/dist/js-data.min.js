/*!
* js-data
* @version 4.0.0-beta.4 - Homepage <http://www.js-data.io/>
* @author js-data project authors
* @copyright (c) 2014-2016 js-data project authors
* @license MIT <https://github.com/js-data/js-data/blob/master/LICENSE>
*
* @overview js-data is a framework-agnostic, datastore-agnostic ORM/ODM for Node.js and the Browser.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define("js-data",["exports"],t):t((e=e||self).JSData={})}(this,function(e){"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(e,t){return e.__proto__=t,e})(e,t)}function _construct(e,t,n){return(_construct=function isNativeReflectConstruct(){if("undefined"!=typeof Reflect&&Reflect.construct&&!Reflect.construct.sham){if("function"==typeof Proxy)return 1;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),1}catch(e){return}}}()?Reflect.construct:function _construct(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&_setPrototypeOf(i,n.prototype),i}).apply(null,arguments)}function _wrapNativeSuper(e){var t="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function _wrapNativeSuper(e){if(null===e||!function _isNativeFunction(e){return-1!==Function.toString.call(e).indexOf("[native code]")}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,Wrapper)}function Wrapper(){return _construct(e,arguments,_getPrototypeOf(this).constructor)}return Wrapper.prototype=Object.create(e.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(Wrapper,e)})(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _get(e,t,n){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function _get(e,t,n){var r=function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}})(e,t,n||e)}function _toConsumableArray(e){return function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function r(e){return t.call(e)}function s(e){return!!e&&"object"===_typeof(e)&&e.constructor===Object}function v(e,t,n){null!==e&&void 0!==e&&e._set?e._set("props.".concat(t),n):A.set(e,t,n)}function w(e,t,n){null!==e&&void 0!==e&&e._set?e._set("links.".concat(t),n):A.set(e,t,n)}function x(){_classCallCheck(this,x);var n={};Object.defineProperties(this,{_get:{value:function value(e){return A.get(n,e)}},_set:{value:function value(e,t){return A.set(n,e,t)}},_unset:{value:function value(e){return A.unset(n,e)}}})}var n="[object Number]",c="[object RegExp]",t=Object.prototype.toString,i=/^(.+)\.(.+)$/,l={400:function _(e,t,n){return"expected: ".concat(arguments.length<=0?void 0:e,", found: ").concat(arguments.length<=2||!n?_typeof(arguments.length<=1?void 0:t):arguments.length<=1?void 0:t)},404:function _(e){return"".concat(arguments.length<=0?void 0:e," not found")}},A={_:function _(n,e){A.forOwn(e,function(e,t){t&&void 0===n[t]&&!A.isFunction(e)&&0!==t.indexOf("_")&&(n[t]=e)})},_forRelation:function _forRelation(e,t,n,r){var i,o=0<arguments.length&&void 0!==e?e:{},a=1<arguments.length?t:void 0,s=2<arguments.length?n:void 0,l=3<arguments.length?r:void 0,u=a.relation,c=null;if(o.with=o.with||[],0<=(i=A._getIndex(o.with,u))?c=u:0<=(i=A._getIndex(o.with,a.localField))&&(c=a.localField),o.withAll)s.call(l,a,{});else if(c){var f={};A.fillIn(f,a.getRelation()),A.fillIn(f,o),f.with=o.with.slice(),f._activeWith=f.with.splice(i,1)[0],f.with.forEach(function(e,t){e&&0===e.indexOf(c)&&e.length>=c.length&&"."===e[c.length]?f.with[t]=e.substr(c.length+1):f.with[t]=""}),s.call(l,a,f)}},_getIndex:function _getIndex(e,n){var r=-1;return e.forEach(function(e,t){return e===n||A.isObject(e)&&e.relation===n?(r=t,!1):void 0}),r},addHiddenPropsToTarget:function addHiddenPropsToTarget(e,n){var r={};Object.keys(n).forEach(function(e){var t=Object.getOwnPropertyDescriptor(n,e);t.enumerable=!1,r[e]=t}),Object.defineProperties(e,r)},areDifferent:function areDifferent(e,t,n){var r=2<arguments.length&&void 0!==n?n:{},i=A.diffObjects(e,t,r);return 0<Object.keys(i.added).length+Object.keys(i.removed).length+Object.keys(i.changed).length},copy:function copy(e,n,t,r,i,o){if(n){if(e===n)throw A.err("".concat("utils",".copy"))(500,"Cannot copy! Source and destination are identical.");if(t=t||[],r=r||[],A.isObject(e)){var a=t.indexOf(e);if(-1!==a)return r[a];t.push(e),r.push(n)}var s,l;if(A.isArray(e))for(l=n.length=0;l<e.length;l++)s=A.copy(e[l],null,t,r,i,o),A.isObject(e[l])&&(t.push(e[l]),r.push(s)),n.push(s);else for(var u in A.isArray(n)?n.length=0:A.forOwn(n,function(e,t){delete n[t]}),e)if(e.hasOwnProperty(u)){if(A.isBlacklisted(u,i))continue;s=A.copy(e[u],null,t,r,i,o),A.isObject(e[u])&&(t.push(e[u]),r.push(s)),n[u]=s}}else(n=e)&&(A.isArray(e)?n=A.copy(e,[],t,r,i,o):A.isDate(e)?n=new Date(e.getTime()):A.isRegExp(e)?(n=new RegExp(e.source,e.toString().match(/[^/]*$/)[0])).lastIndex=e.lastIndex:A.isObject(e)&&(n=o?A.copy(e,{},t,r,i,o):A.copy(e,Object.create(Object.getPrototypeOf(e)),t,r,i,o)));return n},deepFillIn:function deepFillIn(r,e){return e&&A.forOwn(e,function(e,t){var n=r[t];s(e)&&s(n)?A.deepFillIn(n,e):r.hasOwnProperty(t)&&void 0!==r[t]||(r[t]=e)}),r},deepMixIn:function deepMixIn(e,t){if(t)for(var n in t){var r=t[n],i=e[n];s(r)&&s(i)?A.deepMixIn(i,r):e[n]=r}return e},diffObjects:function diffObjects(r,i,e){var t=2<arguments.length&&void 0!==e?e:{},o=t.equalsFn,n=t.ignore,a={added:{},changed:{},removed:{}};A.isFunction(o)||(o=A.deepEqual);var s=Object.keys(r).filter(function(e){return!A.isBlacklisted(e,n)}),l=Object.keys(i).filter(function(e){return!A.isBlacklisted(e,n)});return s.forEach(function(e){var t=i[e],n=r[e];o(t,n)||(void 0===t?a.added[e]=n:a.changed[e]=n)}),l.forEach(function(e){var t=i[e];void 0===r[e]&&void 0!==t&&(a.removed[e]=void 0)}),a},equal:function equal(e,t){return e==t},err:function err(a,s){return function(e){for(var t="[".concat(a,":").concat(s,"] "),n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var o=l[e].apply(null,r);return o="".concat(t).concat(o,"\nhttp://www.js-data.io/v3.0/docs/errors#").concat(e),new Error(o)}},eventify:function eventify(e,s,i){e=e||this;var t={};s||i||(s=function getter(){return t},i=function setter(e){return t=e}),Object.defineProperties(e,{emit:{value:function value(){for(var e=s.call(this)||{},t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];var i,o=n.shift(),a=e[o]||[];for(i=0;i<a.length;i++)a[i].f.apply(a[i].c,n);for(a=e.all||[],n.unshift(o),i=0;i<a.length;i++)a[i].f.apply(a[i].c,n)}},off:{value:function value(e,t){var n=s.call(this)[e];if(n)if(t){for(var r=0;r<n.length;r++)if(n[r].f===t){n.splice(r,1);break}}else n.splice(0,n.length);else i.call(this,{})}},on:{value:function value(e,t,n){s.call(this)||i.call(this,{});var r=s.call(this);r[e]=r[e]||[],r[e].push({c:n,f:t})}}})},fillIn:function fillIn(n,e){A.forOwn(e,function(e,t){n.hasOwnProperty(t)&&void 0!==n[t]||(n[t]=e)})},findIndex:function findIndex(e,n){var r=-1;return e&&e.forEach(function(e,t){if(n(e))return r=t,!1}),r},forEachRelation:function forEachRelation(e,t,n,r){var i=e.relationList||[];i.length&&i.forEach(function(e){A._forRelation(t,e,n,r)})},forOwn:function forOwn(e,t,n){var r,i=Object.keys(e),o=i.length;for(r=0;r<o&&!1!==t.call(n,e[i[r]],i[r],e);r++);},fromJson:function fromJson(e){return A.isString(e)?JSON.parse(e):e},get:function get(e,t){if(t){if(A.isFunction(t))return t(e);for(var n=t.split("."),r=n.pop();t=n.shift();)if(null==(e=e[t]))return;return e[r]}},getSuper:function getSuper(e,t){var n=t?e:e.constructor;return n.hasOwnProperty("__super__")?n.__super__:Object.getPrototypeOf(n)||n.__proto__},intersection:function intersection(e,t){if(!e||!t)return[];e=Array.isArray(e)?e:[e],t=Array.isArray(t)?t:[t];var n,r,i=[],o=e.length;for(r=0;r<o;r++)n=e[r],-1===i.indexOf(n)&&-1!==t.indexOf(n)&&i.push(n);return i},isArray:Array.isArray,isBlacklisted:function isBlacklisted(e,t){if(!t||!t.length)return!1;var n,i=!0,o=!1,a=void 0;try{for(var s,l=t[Symbol.iterator]();!(i=(s=l.next()).done);i=!0){var u=s.value;if(r(u)===c&&u.test(e)||u===e)return!!(n=e)}}catch(e){o=!0,a=e}finally{try{i||null==l.return||l.return()}finally{if(o)throw a}}return!!n},isBoolean:function isBoolean(e){return"[object Boolean]"===r(e)},isDate:function isDate(e){return e&&"object"===_typeof(e)&&"[object Date]"===r(e)},isFunction:function isFunction(e){return"function"==typeof e||e&&"[object Function]"===r(e)},isInteger:function isInteger(e){return r(e)===n&&e==function toInteger(e){if(!e)return 0;if((e=+e)===1/0||e===-1/0)return 17976931348623157e292*(e<0?-1:1);var t=e%1;return e==e?t?e-t:e:0}(e)},isNull:function isNull(e){return null===e},isNumber:function isNumber(e){var t=_typeof(e);return"number"===t||e&&"object"===t&&r(e)===n},isObject:function isObject(e){return"[object Object]"===r(e)},isRegExp:function isRegExp(e){return r(e)===c},isSorN:function isSorN(e){return A.isString(e)||A.isNumber(e)},isString:function isString(e){return"string"==typeof e||e&&"object"===_typeof(e)&&"[object String]"===r(e)},isUndefined:function isUndefined(e){return void 0===e},logify:function logify(e){A.addHiddenPropsToTarget(e,{dbg:function dbg(){if(A.isFunction(this.log)){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.log.apply(this,["debug"].concat(t))}},log:function log(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(e&&!n.length&&(n.push(e),e="debug"),"debug"!==e||this.debug){var i,o,a="".concat(e.toUpperCase(),": (").concat(this.name||this.constructor.name,")");if(A.isFunction(console[e]))(i=console)[e].apply(i,[a].concat(n));else(o=console).log.apply(o,[a].concat(n))}}})},noDupeAdd:function noDupeAdd(e,t,n){e&&this.findIndex(e,n)<0&&e.push(t)},omit:function omit(e,n){var r={};return A.forOwn(e,function(e,t){-1===n.indexOf(t)&&(r[t]=e)}),r},pick:function pick(n,e){return e.reduce(function(e,t){return e[t]=n[t],e},{})},plainCopy:function plainCopy(e){return A.copy(e,void 0,void 0,void 0,void 0,!0)},reject:function reject(e){return Promise.reject(e)},remove:function remove(e,t){if(e&&e.length){var n=this.findIndex(e,t);0<=n&&e.splice(n,1)}},resolve:function resolve(e){return Promise.resolve(e)},set:function set(n,e,t){if(A.isObject(e))A.forOwn(e,function(e,t){A.set(n,t,e)});else{var r=i.exec(e);r?function mkdirP(t,e){return e&&e.split(".").forEach(function(e){t[e]||(t[e]={}),t=t[e]}),t}(n,r[1])[r[2]]=t:n[e]=t}},deepEqual:function deepEqual(n,r){if(n===r)return!0;var i=!0;if(A.isArray(n)&&A.isArray(r)){if(n.length!==r.length)return!1;for(var e=n.length;e--;)if(!A.deepEqual(n[e],r[e]))return!1}else{if(!A.isObject(n)||!A.isObject(r))return!1;A.forOwn(n,function(e,t){if(!(i=A.deepEqual(e,r[t])))return!1}),i&&A.forOwn(r,function(e,t){if(!(i=A.deepEqual(e,n[t])))return!1})}return i},toJson:JSON.stringify,unset:function unset(e,t){for(var n=t.split("."),r=n.pop();t=n.shift();)if(null==(e=e[t]))return;e[r]=void 0},getDefaultLocale:function getDefaultLocale(){return"en"}},o=function(){function Component(){var e,t,n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,Component),(e=_possibleConstructorReturn(this,_getPrototypeOf(Component).call(this)))._listeners={},e.debug=null!=(t=n.debug)&&t,e}return _inherits(Component,x),Component}();A.logify(o.prototype),A.eventify(o.prototype,function(){return this._listeners},function(e){this._listeners=e});var a="Query",u="Index inaccessible after first operation",f={limit:"",offset:"",orderBy:"",skip:"",sort:"",where:"",locale:""},d=/([.*+?^=!:${}()|[\]/\\])/g,h=/%/g,p=/_/g;var y=function(){function Query(e){var t;return _classCallCheck(this,Query),(t=_possibleConstructorReturn(this,_getPrototypeOf(Query).call(this))).collection=e,t.data=null,t}return _inherits(Query,o),_createClass(Query,[{key:"_applyWhereFromObject",value:function _applyWhereFromObject(e){var r=[],i=[],o=[];return A.forOwn(e,function(e,n){A.isObject(e)||(e={"==":e}),A.forOwn(e,function(e,t){r.push(n),i.push(t),o.push(e)})}),{fields:r,ops:i,predicates:o}}},{key:"_applyWhereFromArray",value:function _applyWhereFromArray(i){var o=this,a=[];return i.forEach(function(e,t){if(!A.isString(e)){var n=i[t-1],r=(A.isArray(e)?o._applyWhereFromArray:o._applyWhereFromObject).call(o,e);"or"===n&&(r.isOr=!0),a.push(r)}}),a.isArray=!0,a}},{key:"_testObjectGroup",value:function _testObjectGroup(e,t,n,r){var i,o=n.fields,a=n.ops,s=n.predicates,l=a.length;for(i=0;i<l;i++){var u=a[i],c="|"===u.charAt(0);u=c?u.substr(1):u;var f=this.evaluate(A.get(r,o[i]),u,s[i]);void 0!==f&&(e=t?f:c?e||f:e&&f),t=!1}return{keep:e,first:t}}},{key:"_testArrayGroup",value:function _testArrayGroup(e,t,n,r){var i,o=n.length;for(i=0;i<o;i++){var a=n[i],s=(a.isArray?this._testArrayGroup:this._testObjectGroup).call(this,!0,!0,a,r);e=n[i-1]?a.isOr?e||s.keep:e&&s.keep:s.keep,t=s.first}return{keep:e,first:t}}},{key:"between",value:function between(e,t,n){var r=2<arguments.length&&void 0!==n?n:{};if(this.data)throw A.err("".concat(a,"#between"))(500,"Cannot access index");return this.data=this.collection.getIndex(r.index).between(e,t,r),this}},{key:"compare",value:function compare(e,t,n,r,i){var o=e[t],a=A.get(n,o[0]),s=A.get(r,o[0]);if(a&&A.isString(a)&&(a=a.toUpperCase()),s&&A.isString(s)&&(s=s.toUpperCase()),void 0===n&&(n=null),void 0===r&&(r=null),"DESC"===o[1].toUpperCase()){var l=s;s=a,a=l}var u=i(a,s);return-1===u||1===u?u:t<e.length-1?this.compare(e,t+1,n,r,i):0}},{key:"evaluate",value:function evaluate(e,t,n){var r=Query.ops;return r[t]?r[t](e,n):0===t.indexOf("like")?null!==this.like(n,t.substr(4)).exec(e):0===t.indexOf("notLike")?null===this.like(n,t.substr(7)).exec(e):void 0}},{key:"filter",value:function filter(e,t){var n=this,r=0<arguments.length&&void 0!==e?e:{},i=1<arguments.length?t:void 0;if(this.getData(),A.isObject(r)){var o,a={};(A.isObject(r.where)||A.isArray(r.where))&&(a=r.where),A.forOwn(r,function(e,t){t in f||t in a||(a[t]={"==":e})}),A.isObject(a)&&0!==Object.keys(a).length?o=this._applyWhereFromArray([a]):A.isArray(a)&&(o=this._applyWhereFromArray(a)),o&&(this.data=this.data.filter(function(e){return n._testArrayGroup(!0,!0,o,e).keep}));var s=r.orderBy||r.sort;if(A.isString(s)&&(s=[[s,"ASC"]]),A.isArray(s)||(s=null),s){s.forEach(function(e,t){A.isString(e)&&(s[t]=[e,"ASC"])});var l=A.getDefaultLocale();A.isString(r.locale)&&(l=r.locale);var u=new Intl.Collator(l,{numeric:!0});this.data.sort(function(e,t){return n.compare(s,0,e,t,u.compare)})}A.isNumber(r.skip)?this.skip(r.skip):A.isNumber(r.offset)&&this.skip(r.offset),A.isNumber(r.limit)&&this.limit(r.limit)}else A.isFunction(r)&&(this.data=this.data.filter(r,i));return this}},{key:"forEach",value:function forEach(e,t){return this.getData().forEach(e,t),this}},{key:"get",value:function get(e,t){var n=0<arguments.length&&void 0!==e?e:[],r=1<arguments.length&&void 0!==t?t:{};if(this.data)throw A.err("".concat(a,"#get"))(500,u);return n&&!A.isArray(n)&&(n=[n]),n.length?this.data=this.collection.getIndex(r.index).get(n):this.getData(),this}},{key:"getAll",value:function getAll(){var t=this,e={};if(this.data)throw A.err("".concat(a,"#getAll"))(500,u);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];if(!r.length||1===r.length&&A.isObject(r[0]))return this.getData(),this;r.length&&A.isObject(r[r.length-1])&&(e=r[r.length-1],r.pop());var o=this.collection.getIndex(e.index);return this.data=[],r.forEach(function(e){t.data=t.data.concat(o.get(e))}),this}},{key:"getData",value:function getData(){return this.data||(this.data=this.collection.index.getAll()),this.data}},{key:"like",value:function like(e,t){return new RegExp("^".concat(function escape(e){return e.replace(d,"\\$1")}(e).replace(h,".*").replace(p,"."),"$"),t)}},{key:"limit",value:function limit(e){if(!A.isNumber(e))throw A.err("".concat(a,"#limit"),"num")(400,"number",e);var t=this.getData();return this.data=t.slice(0,Math.min(t.length,e)),this}},{key:"map",value:function map(e,t){return this.data=this.getData().map(e,t),this}},{key:"mapCall",value:function mapCall(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];return this.data=this.getData().map(function(e){return e[t].apply(e,n)}),this}},{key:"run",value:function run(){var e=this.data;return this.data=null,e}},{key:"skip",value:function skip(e){if(!A.isNumber(e))throw A.err("".concat(a,"#skip"),"num")(400,"number",e);var t=this.getData();return e<t.length?this.data=t.slice(e):this.data=[],this}}]),Query}();y.ops={"=":function _(e,t){return e==t},"==":function _(e,t){return e==t},"===":function _(e,t){return e===t},"!=":function _(e,t){return e!=t},"!==":function _(e,t){return e!==t},">":function _(e,t){return t<e},">=":function _(e,t){return t<=e},"<":function _(e,t){return e<t},"<=":function _(e,t){return e<=t},isectEmpty:function isectEmpty(e,t){return!A.intersection(e||[],t||[]).length},isectNotEmpty:function isectNotEmpty(e,t){return A.intersection(e||[],t||[]).length},in:function _in(e,t){return-1!==t.indexOf(e)},notIn:function notIn(e,t){return-1===t.indexOf(e)},contains:function contains(e,t){return-1!==(e||[]).indexOf(t)},notContains:function notContains(e,t){return-1===(e||[]).indexOf(t)}};var O="belongsTo",C="hasMany",R="hasOne",g="Relation",m=function(){function Relation(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Relation),this.TYPE_NAME=g,t.type=this.constructor.TYPE_NAME,this.validateOptions(e,t),"object"===_typeof(e)&&(this.relatedMapper=e),A.fillIn(this,t)}return _createClass(Relation,[{key:"validateOptions",value:function validateOptions(e,t){var n="new ".concat(g),r=t.localField;if(!r)throw A.err(n,"opts.localField")(400,"string",r);var i=t.foreignKey=t.foreignKey||t.localKey;if(!i&&(t.type===O||t.type===R))throw A.err(n,"opts.foreignKey")(400,"string",i);if(A.isString(e)){if(t.relation=e,!A.isFunction(t.getRelation))throw A.err(n,"opts.getRelation")(400,"function",t.getRelation)}else{if(!e)throw A.err(n,"related")(400,"Mapper or string",e);t.relation=e.name}}},{key:"assignTo",value:function assignTo(e){this.name=e.name,Object.defineProperty(this,"mapper",{value:e}),e.relationList||Object.defineProperty(e,"relationList",{value:[]}),e.relationFields||Object.defineProperty(e,"relationFields",{value:[]}),e.relationList.push(this),e.relationFields.push(this.localField)}},{key:"canFindLinkFor",value:function canFindLinkFor(){return!(!this.foreignKey&&!this.localKey)}},{key:"getRelation",value:function getRelation(){return this.relatedMapper}},{key:"getForeignKey",value:function getForeignKey(e){return A.get(e,this.mapper.idAttribute)}},{key:"setForeignKey",value:function setForeignKey(e,t){e&&t&&this._setForeignKey(e,t)}},{key:"_setForeignKey",value:function _setForeignKey(t,e){var n=this,r=this.mapper.idAttribute;A.isArray(e)||(e=[e]),e.forEach(function(e){A.set(e,n.foreignKey,A.get(t,r))})}},{key:"getLocalField",value:function getLocalField(e){return A.get(e,this.localField)}},{key:"setLocalField",value:function setLocalField(e,t){return A.set(e,this.localField,t)}},{key:"getInverse",value:function getInverse(e){return this.inverse||this.findInverseRelation(e),this.inverse}},{key:"findInverseRelation",value:function findInverseRelation(t){var n=this;this.getRelation().relationList.forEach(function(e){if(e.getRelation()===t&&n.isInversedTo(e)&&n!==e)return n.inverse=e,!0})}},{key:"isInversedTo",value:function isInversedTo(e){return!e.foreignKey||e.foreignKey===this.foreignKey}},{key:"addLinkedRecords",value:function addLinkedRecords(e){var n=this,r=this.mapper.datastore;e.forEach(function(e){var t=n.getLocalField(e);(!(t=A.isFunction(n.add)?n.add(r,n,e):t&&n.linkRecord(e,t))||A.isArray(t)&&!t.length)&&n.canFindLinkFor(e)&&(t=n.findExistingLinksFor(e)),t&&n.setLocalField(e,t)})}},{key:"removeLinkedRecords",value:function removeLinkedRecords(e,t){var n=this.localField;t.forEach(function(e){A.set(e,n,void 0)})}},{key:"linkRecord",value:function linkRecord(e,t){var n=A.get(t,this.mapper.idAttribute);void 0===n?-1===this.relatedCollection.unsaved().indexOf(t)&&this.canAutoAddLinks&&(t=this.relatedCollection.add(t)):t!==this.relatedCollection.get(n)&&(this.setForeignKey(e,t),this.canAutoAddLinks&&(t=this.relatedCollection.add(t)));return t}},{key:"findExistingLinksByForeignKey",value:function findExistingLinksByForeignKey(e){if(null!=e)return this.relatedCollection.filter(_defineProperty({},this.foreignKey,e))}},{key:"ensureLinkedDataHasProperType",value:function ensureLinkedDataHasProperType(e,t){var n=this.getRelation(),r=this.getLocalField(e);A.isArray(r)&&(!r.length||n.is(r[0]))||!r||n.is(r)||A.set(e,this.localField,n.createRecord(r,t))}},{key:"isRequiresParentId",value:function isRequiresParentId(){return!1}},{key:"isRequiresChildId",value:function isRequiresChildId(){return!1}},{key:"createChildRecord",value:function createChildRecord(t,e,n){var r=this;return this.setForeignKey(t,e),this.createLinked(e,n).then(function(e){r.setLocalField(t,e)})}},{key:"createLinked",value:function createLinked(e,t){var n=A.isArray(e)?"createMany":"create";return this.getRelation()[n](e,t)}},{key:"canAutoAddLinks",get:function get(){return void 0===this.add||!!this.add}},{key:"relatedCollection",get:function get(){return this.mapper.datastore.getCollection(this.relation)}}]),Relation}();function superMethod(r,i){var o=r.datastore;return null!==o&&void 0!==o&&o[i]?function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[i].apply(o,[r.name].concat(t))}:r[i].bind(r)}var k="creating",b="noValidate",S="keepChangeHistory",E="previous",I=function(){function Record(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Record);var r=(e=_possibleConstructorReturn(this,_getPrototypeOf(Record).call(this)))._set,i=e.constructor.mapper;r(k,!0),r(b,!!n.noValidate),r(S,void 0===n.keepChangeHistory?!i||i.keepChangeHistory:n.keepChangeHistory);var o=i?A.get(t,i.idAttribute):void 0;return void 0!==o&&A.set(_assertThisInitialized(e),i.idAttribute,o),A.fillIn(_assertThisInitialized(e),t),r(k,!1),void 0!==n.validateOnSet?r(b,!n.validateOnSet):void 0!==(null===i||void 0===i?void 0:i.validateOnSet)?r(b,!i.validateOnSet):r(b,!1),r(E,i?i.toJSON(t):A.plainCopy(t)),e}return _inherits(Record,x),_createClass(Record,[{key:"_mapper",value:function _mapper(){var e=this.constructor.mapper;if(!e)throw A.err("".concat("Record","#_mapper"),"")(404,"mapper");return e}},{key:"afterLoadRelations",value:function afterLoadRelations(){}},{key:"beforeLoadRelations",value:function beforeLoadRelations(){}},{key:"changeHistory",value:function changeHistory(){return(this._get("history")||[]).slice()}},{key:"changes",value:function changes(e){var t=0<arguments.length&&void 0!==e?e:{};return A.diffObjects("function"==typeof this.toJSON?this.toJSON(t):this,this._get("previous"),t)}},{key:"commit",value:function commit(e){this._set("changed"),this._set("changing",!1),this._set("history",[]),this._set("previous",this.toJSON(e))}},{key:"destroy",value:function destroy(e){var t=0<arguments.length&&void 0!==e?e:{},n=this._mapper();return superMethod(n,"destroy")(A.get(this,n.idAttribute),t)}},{key:"get",value:function get(e){return A.get(this,e)}},{key:"hasChanges",value:function hasChanges(e){return!!(this._get("changed")||[]).length||A.areDifferent("function"==typeof this.toJSON?this.toJSON(e):this,this._get("previous"),e)}},{key:"isNew",value:function isNew(){return void 0===A.get(this,this._mapper().idAttribute)}},{key:"isValid",value:function isValid(e){return!this._mapper().validate(this,e)}},{key:"removeInverseRelation",value:function removeInverseRelation(e,t,n,r){var i=this;if(n.type===R)w(e,n.localField,void 0);else if(n.type===C){var o=A.get(e,n.localField);void 0===t?A.remove(o,function(e){return e===i}):A.remove(o,function(e){return e===i||t===A.get(e,r)})}}},{key:"setupInverseRelation",value:function setupInverseRelation(e,t,n,r){var i=this;if(n.type===R)w(e,n.localField,this);else if(n.type===C){var o=A.get(e,n.localField);void 0===t?A.noDupeAdd(o,this,function(e){return e===i}):A.noDupeAdd(o,this,function(e){return e===i||t===A.get(e,r)})}}},{key:"loadRelations",value:function loadRelations(e,t){var n,a=this,r=0<arguments.length&&void 0!==e?e:[],s=1<arguments.length&&void 0!==t?t:{},l=this._mapper();return A.isString(r)&&(r=[r]),s.with=r,A._(s,l),s.adapter=l.getAdapterName(s),n=s.op="beforeLoadRelations",A.resolve(this[n](r,s)).then(function(){n=s.op="loadRelations",l.dbg(n,a,r,s);var i,o=[];return A.forEachRelation(l,s,function(t,e){var n=t.getRelation();if(e.raw=!1,A.isFunction(t.load))i=t.load(l,t,a,s);else if("hasMany"===t.type||"hasOne"===t.type)t.foreignKey?i=superMethod(n,"findAll")(_defineProperty({},t.foreignKey,A.get(a,l.idAttribute)),e).then(function(e){return"hasOne"===t.type?e.length?e[0]:void 0:e}):t.localKeys?i=superMethod(n,"findAll")({where:_defineProperty({},n.idAttribute,{in:A.get(a,t.localKeys)})}):t.foreignKeys&&(i=superMethod(n,"findAll")({where:_defineProperty({},t.foreignKeys,{contains:A.get(a,l.idAttribute)})},s));else if("belongsTo"===t.type){var r=A.get(a,t.foreignKey);A.isSorN(r)&&(i=superMethod(n,"find")(r,e))}i&&(i=i.then(function(e){t.setLocalField(a,e)}),o.push(i))}),Promise.all(o)}).then(function(){return n=s.op="afterLoadRelations",A.resolve(a[n](r,s)).then(function(){return a})})}},{key:"previous",value:function previous(e){return e?this._get("previous.".concat(e)):this._get("previous")}},{key:"revert",value:function revert(e){var n=this,r=0<arguments.length&&void 0!==e?e:{},i=this._get("previous");r.preserve=r.preserve||[],A.forOwn(this,function(e,t){t!==n._mapper().idAttribute&&!i.hasOwnProperty(t)&&n.hasOwnProperty(t)&&-1===r.preserve.indexOf(t)&&delete n[t]}),A.forOwn(i,function(e,t){-1===r.preserve.indexOf(t)&&(n[t]=e)}),this.commit()}},{key:"save",value:function save(e){function Pk(e){var t=r.raw?e.data:e;return t&&(A.deepMixIn(n,t),n.commit()),e}var n=this,r=0<arguments.length&&void 0!==e?e:{},t=this._mapper(),i=A.get(this,t.idAttribute),o=this;if(void 0===i)return superMethod(t,"create")(o,r).then(Pk);if(r.changesOnly){var a=this.changes(r);o={},A.fillIn(o,a.added),A.fillIn(o,a.changed)}return superMethod(t,"update")(i,o,r).then(Pk)}},{key:"set",value:function set(e,t,n){A.isObject(e)&&(n=t),(n=n||{}).silent&&this._set("silent",!0),A.set(this,e,t),this._get("eventId")||this._set("silent")}},{key:"toJSON",value:function toJSON(e){var t=this.constructor.mapper;if(t)return t.toJSON(this,e);var n={};return A.forOwn(this,function(e,t){n[t]=A.plainCopy(e)}),n}},{key:"unset",value:function unset(e,t){this.set(e,void 0,t)}},{key:"validate",value:function validate(e){return this._mapper().validate(this,e)}}]),Record}();function insertAt(e,t,n){return e.splice(t,0,n),e}function removeAt(e,t){return e.splice(t,1),e}function binarySearch(e,t,n){for(var r,i,o,a,s,l=0,u=e.length;l<u;){if(o=t,a=e[i=(l+u)/2|0],s=n,0==(r=o===a?0:(s&&(o=s(o),a=s(a)),null===o&&null===a||void 0===o&&void 0===a||null==o?-1:null==a?1:o<a?-1:a<o?1:0)))return{found:!0,index:i};r<0?u=i:l=1+i}return{found:!1,index:u}}I.creatingPath=k,I.noValidatePath=b,I.keepChangeHistoryPath=S,I.previousPath=E,A.eventify(I.prototype,function(){return this._get("events")},function(e){this._set("events",e)});var P=function(){function Index(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(_classCallCheck(this,Index),!A.isArray(e))throw new Error("fieldList must be an array.");this.fieldList=e,this.fieldGetter=t.fieldGetter,this.hashCode=t.hashCode,this.isIndex=!0,this.keys=[],this.values=[]}return _createClass(Index,[{key:"set",value:function set(e,t){A.isArray(e)||(e=[e]);var n=e.shift()||void 0,r=binarySearch(this.keys,n);if(0===e.length)if(r.found){var i=binarySearch(this.values[r.index],t,this.hashCode);i.found||insertAt(this.values[r.index],i.index,t)}else insertAt(this.keys,r.index,n),insertAt(this.values,r.index,[t]);else if(r.found)this.values[r.index].set(e,t);else{insertAt(this.keys,r.index,n);var o=new Index([],{hashCode:this.hashCode});o.set(e,t),insertAt(this.values,r.index,o)}}},{key:"get",value:function get(e){A.isArray(e)||(e=[e]);var t=e.shift()||void 0,n=binarySearch(this.keys,t);return 0===e.length?n.found?this.values[n.index].isIndex?this.values[n.index].getAll():this.values[n.index].slice():[]:n.found?this.values[n.index].get(e):[]}},{key:"getAll",value:function getAll(e){var t=0<arguments.length&&void 0!==e?e:{},n=[],r=this.values;if("desc"===t.order)for(var i=r.length-1;0<=i;i--){var o=r[i];n=o.isIndex?n.concat(o.getAll(t)):n.concat(o)}else{var a=!0,s=!1,l=void 0;try{for(var u,c=r[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var f=u.value;n=f.isIndex?n.concat(f.getAll(t)):n.concat(f)}}catch(e){s=!0,l=e}finally{try{a||null==c.return||c.return()}finally{if(s)throw l}}}return n}},{key:"visitAll",value:function visitAll(t,n){this.values.forEach(function(e){e.isIndex?e.visitAll(t,n):e.forEach(t,n)})}},{key:"between",value:function between(e,t,n){var r=2<arguments.length&&void 0!==n?n:{};A.isArray(e)||(e=[e]),A.isArray(t)||(t=[t]),A.fillIn(r,{leftInclusive:!0,rightInclusive:!1,limit:void 0,offset:0});var i=this._between(e,t,r);return r.limit?i.slice(r.offset,r.limit+r.offset):i.slice(r.offset)}},{key:"_between",value:function _between(e,t,n){var r,i=[],o=e.shift(),a=t.shift();if(r=void 0!==o?binarySearch(this.keys,o):{found:!1,index:0},0===e.length){r.found&&!1===n.leftInclusive&&(r.index+=1);for(var s=r.index;s<this.keys.length;s+=1){if(void 0!==a)if(n.rightInclusive){if(this.keys[s]>a)break}else if(this.keys[s]>=a)break;if(i=this.values[s].isIndex?i.concat(this.values[s].getAll()):i.concat(this.values[s]),n.limit&&i.length>=n.limit+n.offset)break}}else for(var l=r.index;l<this.keys.length;l+=1){var u=this.keys[l];if(a<u)break;if(i=this.values[l].isIndex?u===o?i.concat(this.values[l]._between(A.copy(e),t.map(function(){}),n)):u===a?i.concat(this.values[l]._between(e.map(function(){}),A.copy(t),n)):i.concat(this.values[l].getAll()):i.concat(this.values[l]),n.limit&&i.length>=n.limit+n.offset)break}return n.limit?i.slice(0,n.limit+n.offset):i}},{key:"peek",value:function peek(){return this.values.length?this.values[0].isIndex?this.values[0].peek():this.values[0]:[]}},{key:"clear",value:function clear(){this.keys=[],this.values=[]}},{key:"insertRecord",value:function insertRecord(t){var e=this.fieldList.map(function(e){return A.isFunction(e)?e(t)||void 0:t[e]||void 0});this.set(e,t)}},{key:"removeRecord",value:function removeRecord(i){var o,a=this,s=void 0!==this.hashCode(i);return this.values.forEach(function(e,t){if(e.isIndex){if(e.removeRecord(i))return 0===e.keys.length&&(removeAt(a.keys,t),removeAt(a.values,t)),!(o=!0)}else{var n={};if(void 0!==a.keys[t]&&s)s&&(n=binarySearch(e,i,a.hashCode));else for(var r=e.length-1;0<=r;r--)if(e[r]===i){n={found:!0,index:r};break}if(n.found)return removeAt(e,n.index),0===e.length&&(removeAt(a.keys,t),removeAt(a.values,t)),!(o=!0)}}),o?i:void 0}},{key:"updateRecord",value:function updateRecord(e){void 0!==this.removeRecord(e)&&this.insertRecord(e)}}]),Index}(),F=I.noValidatePath,M="Collection",j={commitOnMerge:!0,emitRecordEvents:!0,idAttribute:"id",onConflict:"merge"},L=function(){function Collection(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,Collection),(e=_possibleConstructorReturn(this,_getPrototypeOf(Collection).call(this,n))).indexes={},e._added={},t&&!A.isArray(t)&&(n=t,t=[]),A.isString(n)&&(n={idAttribute:n}),A.fillIn(_assertThisInitialized(e),n),A.fillIn(_assertThisInitialized(e),A.copy(j)),e.queryClass||(e.queryClass=y);var r=e.recordId();return e.index=new P([r],{hashCode:function hashCode(e){return A.get(e,r)}}),(A.isObject(t)||A.isArray(t)&&t.length)&&e.add(t),e}return _inherits(Collection,o),_createClass(Collection,[{key:"_onRecordEvent",value:function _onRecordEvent(){this.emitRecordEvents&&this.emit.apply(this,arguments)}},{key:"add",value:function add(e,t){var o=this,a=1<arguments.length&&void 0!==t?t:{};A._(a,this),e=this.beforeAdd(e,a)||e;var n=!1,s=this.recordId();if(!A.isArray(e)){if(!A.isObject(e))throw A.err("".concat(M,"#add"),"records")(400,"object or array",e);e=[e],n=!0}e=e.map(function(n){var e=o.recordId(n),r=void 0===e?e:o.get(e);if(n===r)return r;if(r){var t=a.onConflict||o.onConflict;if("merge"!==t&&"replace"!==t&&"skip"!==t)throw A.err("".concat(M,"#add"),"opts.onConflict")(400,"one of (merge, replace, skip)",t,!0);var i=r._get(F);a.noValidate&&r._set(F,!0),"merge"===t?A.deepMixIn(r,n):"replace"===t&&(A.forOwn(r,function(e,t){t!==s&&void 0===n[t]&&(r[t]=void 0)}),r.set(n)),a.noValidate&&r._set(F,i),n=r,a.commitOnMerge&&A.isFunction(n.commit)&&n.commit(),o.updateIndexes(n)}else n=o.mapper?o.mapper.createRecord(n,a):n,o.index.insertRecord(n),A.forOwn(o.indexes,function(e,t){e.insertRecord(n)}),n&&A.isFunction(n.on)&&n.on("all",o._onRecordEvent,o);return n});var r=n?e[0]:e;return a.silent||this.emit("add",r),this.afterAdd(e,a,r)||r}},{key:"afterAdd",value:function afterAdd(){return null}},{key:"afterRemove",value:function afterRemove(){return null}},{key:"afterRemoveAll",value:function afterRemoveAll(){return null}},{key:"beforeAdd",value:function beforeAdd(){return null}},{key:"beforeRemove",value:function beforeRemove(){return null}},{key:"beforeRemoveAll",value:function beforeRemoveAll(){return null}},{key:"between",value:function between(e,t,n){return this.query().between(e,t,n).run()}},{key:"createIndex",value:function createIndex(e,t,n){var r=this,i=2<arguments.length&&void 0!==n?n:{};A.isString(e)&&void 0===t&&(t=[e]),i.hashCode=i.hashCode||function(e){return r.recordId(e)};var o=this.indexes[e]=new P(t,i);this.index.visitAll(o.insertRecord,o)}},{key:"filter",value:function filter(e,t){return this.query().filter(e,t).run()}},{key:"forEach",value:function forEach(e,t){this.index.visitAll(e,t)}},{key:"get",value:function get(e){var t=void 0===e?[]:this.query().get(e).run();return t.length?t[0]:void 0}},{key:"getAll",value:function getAll(){var e;return(e=this.query()).getAll.apply(e,arguments).run()}},{key:"getIndex",value:function getIndex(e){var t=e?this.indexes[e]:this.index;if(!t)throw A.err("".concat(M,"#getIndex"),e)(404,"index");return t}},{key:"limit",value:function limit(e){return this.query().limit(e).run()}},{key:"map",value:function map(t,n){var r=[];return this.index.visitAll(function(e){r.push(t.call(n,e))}),r}},{key:"mapCall",value:function mapCall(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];var i=[];return this.index.visitAll(function(e){i.push(e[t].apply(e,n))}),i}},{key:"prune",value:function prune(e){return this.removeAll(this.unsaved(),e)}},{key:"query",value:function query(){return new this.queryClass(this)}},{key:"recordId",value:function recordId(e){return e?A.get(e,this.recordId()):this.mapper?this.mapper.idAttribute:this.idAttribute}},{key:"reduce",value:function reduce(e,t){return this.getAll().reduce(e,t)}},{key:"remove",value:function remove(e,t){var n=1<arguments.length&&void 0!==t?t:{};this.beforeRemove(e,n);var r=A.isSorN(e)?this.get(e):e;return A.isObject(r)&&(r=this.index.removeRecord(r))&&(A.forOwn(this.indexes,function(e,t){e.removeRecord(r)}),A.isFunction(r.off)&&r.off("all",this._onRecordEvent,this),n.silent||this.emit("remove",r)),this.afterRemove(e,n,r)||r}},{key:"removeAll",value:function removeAll(e,t){var n=this,r=1<arguments.length&&void 0!==t?t:{};this.beforeRemoveAll(e,r);var i=A.isArray(e)?e.slice():this.filter(e),o=A.plainCopy(r);return o.silent=!0,i=i.map(function(e){return n.remove(e,o)}).filter(function(e){return e}),r.silent||this.emit("remove",i),this.afterRemoveAll(e,r,i)||i}},{key:"skip",value:function skip(e){return this.query().skip(e).run()}},{key:"toJSON",value:function toJSON(e){return this.mapCall("toJSON",e)}},{key:"unsaved",value:function unsaved(){return this.index.get()}},{key:"updateIndex",value:function updateIndex(e,t){var n=1<arguments.length&&void 0!==t?t:{};this.getIndex(n.index).updateRecord(e)}},{key:"updateIndexes",value:function updateIndexes(t){this.index.updateRecord(t),A.forOwn(this.indexes,function(e){return e.updateRecord(t)})}}]),Collection}(),T=function(){function TsDataError(){return _classCallCheck(this,TsDataError),_possibleConstructorReturn(this,_getPrototypeOf(TsDataError).apply(this,arguments))}return _inherits(TsDataError,_wrapNativeSuper(Error)),TsDataError}(),D={array:A.isArray,boolean:A.isBoolean,integer:A.isInteger,null:A.isNull,number:A.isNumber,object:A.isObject,string:A.isString};function segmentToString(e,t){var n="";return e&&(A.isNumber(e)?n+="[".concat(e,"]"):n+=t?".".concat(e):"".concat(e)),n}function makeError(e,t,n){return{expected:t,actual:""+e,path:function makePath(e){var t=0<arguments.length&&void 0!==e?e:{},n="";return(t.path||[]).forEach(function(e){n+=segmentToString(e,n)}),n+=segmentToString(t.prop,n)}(n)}}function addError(e,t,n,r){r.push(makeError(e,t,n))}function maxLengthCommon(e,t,n,r){var i=n[e];if(t.length>i)return makeError(t.length,"length no more than ".concat(i),r)}function minLengthCommon(e,t,n,r){var i=n[e];if(t.length<i)return makeError(t.length,"length no less than ".concat(i),r)}var N={allOf:function allOf(t,e,n){var r=[];return e.allOf.forEach(function(e){r=r.concat(H(t,e,n)||[])}),r.length?r:void 0},anyOf:function anyOf(n,e,r){var i=!1,o=[];return e.anyOf.forEach(function(e){var t=H(n,e,r);t?o=o.concat(t):i=!0}),i?void 0:o},dependencies:function dependencies(){},enum:function _enum(t,e,n){var r=e.enum;if(-1===A.findIndex(r,function(e){return A.deepEqual(e,t)}))return makeError(t,"one of (".concat(r.join(", "),")"),n)},items:function items(e,t){for(var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},items=t.items,r=[],i=A.isArray(items),o=e.length,a=0;a<o;a++)i&&(items=t.items[a]),n.prop=a,r=r.concat(H(e[a],items,n)||[]);return r.length?r:void 0},maximum:function maximum(e,t,n){var maximum=t.maximum,r=t.exclusiveMaximum;if(_typeof(e)===_typeof(maximum)&&!(r?e<maximum:e<=maximum))return makeError(e,r?"no more than nor equal to ".concat(maximum):"no more than ".concat(maximum),n)},maxItems:function maxItems(e,t,n){if(A.isArray(e))return maxLengthCommon("maxItems",e,t,n)},maxLength:function maxLength(e,t,n){return maxLengthCommon("maxLength",e,t,n)},maxProperties:function maxProperties(e,t,n){if(A.isObject(e)){var maxProperties=t.maxProperties,r=Object.keys(e).length;return maxProperties<r?makeError(r,"no more than ".concat(maxProperties," properties"),n):void 0}},minimum:function minimum(e,t,n){var minimum=t.minimum,r=t.exclusiveMinimum;if(_typeof(e)===_typeof(minimum)&&!(r?minimum<e:minimum<=e))return makeError(e,r?"no less than nor equal to ".concat(minimum):"no less than ".concat(minimum),n)},minItems:function minItems(e,t,n){if(A.isArray(e))return minLengthCommon("minItems",e,t,n)},minLength:function minLength(e,t,n){return minLengthCommon("minLength",e,t,n)},minProperties:function minProperties(e,t,n){if(A.isObject(e)){var minProperties=t.minProperties,r=Object.keys(e).length;return r<minProperties?makeError(r,"no more than ".concat(minProperties," properties"),n):void 0}},multipleOf:function multipleOf(e,t,n){var multipleOf=t.multipleOf;if(A.isNumber(e)&&e/multipleOf%1!=0)return makeError(e,"multipleOf ".concat(multipleOf),n)},not:function not(e,t,n){if(!H(e,t.not,n))return makeError("succeeded","should have failed",n)},oneOf:function oneOf(n,e,r){var i=!1,o=[];return e.oneOf.forEach(function(e){var t=H(n,e,r);if(t)o=o.concat(t);else{if(i)return o=[makeError("valid against more than one","valid against only one",r)],i=!1;i=!0}}),i?void 0:o},pattern:function pattern(e,t,n){var pattern=t.pattern;if(A.isString(e)&&!e.match(pattern))return makeError(e,pattern,n)},properties:function properties(i,e){var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if(!A.isArray(i)){var t=void 0===e.additionalProperties||e.additionalProperties,a=[],properties=e.properties||{},n=e.patternProperties||{},s=[];A.forOwn(properties,function(e,t){o.prop=t,s=s.concat(H(i[t],e,o)||[]),a.push(t)});var l=A.omit(i,a);A.forOwn(n,function(n,r){A.forOwn(l,function(e,t){t.match(r)&&(o.prop=t,s=s.concat(H(i[t],n,o)||[]),a.push(t))})});var r=Object.keys(A.omit(i,a));if(!1===t){if(r.length){var u=o.prop;o.prop="",addError("extra fields: ".concat(r.join(", ")),"no extra fields",o,s),o.prop=u}}else A.isObject(t)&&r.forEach(function(e){o.prop=e,s=s.concat(H(i[e],t,o)||[])});return s.length?s:void 0}},required:function required(n,e){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},required=e.required,i=[];return r.existingOnly||required.forEach(function(e){if(void 0===A.get(n,e)){var t=r.prop;r.prop=e,addError(void 0,"a value",r,i),r.prop=t}}),i.length?i:void 0},type:function type(t,n,r){var i,type=n.type;if(A.isString(type)&&(type=[type]),type.forEach(function(e){if(D[e](t,n,r))return i=e,!1}),!i)return makeError(null!=t?_typeof(t):""+t,"one of (".concat(type.join(", "),")"),r);var e=G[i];return e?e(t,n,r):void 0},uniqueItems:function uniqueItems(e,t,n){var r,i,o;if(null!==e&&void 0!==e&&e.length&&t.uniqueItems)for(i=e.length-1;0<i;i--)for(r=e[i],o=i-1;0<=o;o--)if(A.deepEqual(r,e[o]))return makeError(r,"no duplicates",n)}};function runOps(e,t,n,r){var i=[];return e.forEach(function(e){void 0!==n[e]&&(i=i.concat(N[e](t,n,r)||[]))}),i.length?i:void 0}var K=["enum","type","allOf","anyOf","oneOf","not"],q=["items","maxItems","minItems","uniqueItems"],J=["multipleOf","maximum","minimum"],B=["maxProperties","minProperties","required","properties","dependencies"],Q=["maxLength","minLength","pattern"],H=function validate(e,t,n){var r,i=2<arguments.length&&void 0!==n?n:{},o=[];i.ctx=i.ctx||{value:e,schema:t};var a=i.prop;if(void 0!==t){if(!A.isObject(t))throw A.err("".concat("Schema","#validate"))(500,'Invalid schema at path: "'.concat(i.path,'"'));return(void 0===i.path&&(i.path=[]),void 0!==i.prop&&(r=!0,i.path.push(i.prop),i.prop=void 0),t.extends&&(o=A.isFunction(t.extends.validate)?o.concat(t.extends.validate(e,i)||[]):o.concat(H(e,t.extends,i)||[])),void 0===e)?(!0!==t.required||i.existingOnly||addError(e,"a value",i,o),r&&(i.path.pop(),i.prop=a),o.length?o:void 0):(o=o.concat(function validateAny(e,t,n){return runOps(K,e,t,n)}(e,t,i)||[]),r&&(i.path.pop(),i.prop=a),o.length?o:void 0)}},U="changing",V="changed",W="history",$="eventId",G={array:function array(e,t,n){return runOps(q,e,t,n)},integer:function integer(e,t,n){return G.numeric(e,t,n)},number:function number(e,t,n){return G.numeric(e,t,n)},numeric:function numeric(e,t,n){return runOps(J,e,t,n)},object:function object(e,t,n){return runOps(B,e,t,n)},string:function string(e,t,n){return runOps(Q,e,t,n)}},z=function(){function Schema(){var r,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,Schema),r=_possibleConstructorReturn(this,_getPrototypeOf(Schema).call(this)),A.fillIn(_assertThisInitialized(r),e),"object"===r.type?(r.properties=r.properties||{},A.forOwn(r.properties,function(e,t){e instanceof Schema||(r.properties[t]=new Schema(e))})):"array"!==r.type||!r.items||r.items instanceof Schema||(r.items=new Schema(r.items)),!r.extends||r.extends instanceof Schema||(r.extends=new Schema(r.extends)),["allOf","anyOf","oneOf"].forEach(function(n){r[n]&&r[n].forEach(function(e,t){e instanceof Schema||(r[n][t]=new Schema(e))})}),r}return _inherits(Schema,o),_createClass(Schema,[{key:"apply",value:function apply(n,e){var r=this,i=1<arguments.length&&void 0!==e?e:{};i.getter=i.getter||"_get",i.setter=i.setter||"_set",i.unsetter=i.unsetter||"_unset",i.track=i.track||this.track;var t=this.properties||{};A.forOwn(t,function(e,t){Object.defineProperty(n,t,r.makeDescriptor(t,e,i))})}},{key:"applyDefaults",value:function applyDefaults(r){if(r){var e=this.properties||{},i=A.isFunction(r.set)||A.isFunction(r._set);A.forOwn(e,function(e,t){if(e.hasOwnProperty("default")&&void 0===A.get(r,t)&&(i?r.set(t,A.plainCopy(e.default),{silent:!0}):A.set(r,t,A.plainCopy(e.default))),"object"===e.type&&e.properties){if(i){var n=r._get("noValidate");r._set("noValidate",!0),A.set(r,t,A.get(r,t)||{},{silent:!0}),r._set("noValidate",n)}else A.set(r,t,A.get(r,t)||{});e.applyDefaults(A.get(r,t))}})}}},{key:"makeDescriptor",value:function makeDescriptor(d,h,e){var t={configurable:!0,enumerable:void 0===h.enumerable||!!h.enumerable,get:function get(){return this._get(p)},set:function set(i){var o=this,a=this[y],s=this[g],l=this[m];if(!a("noValidate")){var e=h.validate(i,{path:[d]});if(e){var t=new T("validation failed");throw t.errors=e,t}}if(k&&!a("creating")){var n=a(v),u=a(p),r=a(U),c=a(V);r||(c=[]);var f=c.indexOf(d);u!==i&&-1===f&&c.push(d),n===i&&0<=f&&c.splice(f,1),c.length||(r=!1,l(U),l(V),a($)&&(clearTimeout(a($)),l($))),!r&&c.length&&(s(V,c),s(U,!0),s($,setTimeout(function(){if(l(V),l($),l(U),!a("silent")){var e;for(e=0;e<c.length;e++)o.emit("change:"+c[e],o,A.get(o,c[e]));var t=A.diffObjects(_defineProperty({},d,i),_defineProperty({},d,u));if(a("keepChangeHistory")){var n=A.plainCopy(t);n.timestamp=(new Date).getTime();var r=a(W);r||s(W,r=[]),r.push(n)}o.emit("change",o,t)}l("silent")},0)))}return s(p,i),i}},p="props.".concat(d),v="previous.".concat(d),y=e.getter,g=e.setter,m=e.unsetter,k=A.isBoolean(e.track)?e.track:h.track;if(A.isFunction(h.get)){var n=t.get;t.get=function(){return h.get.call(this,n)}}if(A.isFunction(h.set)){var r=t.set;t.set=function(e){return h.set.call(this,e,r)}}return t}},{key:"pick",value:function pick(n){var r=this;if(void 0!==n){if("object"!==this.type)return"array"===this.type?n.map(function(e){var t=r.items?r.items.pick(e):{};return r.extends&&A.fillIn(t,r.extends.pick(e)),t}):A.plainCopy(n);var i={},e=this.properties;if(e&&A.forOwn(e,function(e,t){i[t]=e.pick(n[t])}),this.extends&&A.fillIn(i,this.extends.pick(n)),this.additionalProperties)for(var t in n)e[t]||(i[t]=A.plainCopy(n[t]));return i}}},{key:"validate",value:function validate(e,t){return H(e,this,t)}}]),Schema}();z.ANY_OPS=K,z.ARRAY_OPS=q,z.NUMERIC_OPS=J,z.OBJECT_OPS=B,z.STRING_OPS=Q,z.typeGroupValidators=G,z.types=D,z.validate=H,z.validationKeywords=N;var Y=function(){function BelongsToRelation(){return _classCallCheck(this,BelongsToRelation),_possibleConstructorReturn(this,_getPrototypeOf(BelongsToRelation).apply(this,arguments))}return _inherits(BelongsToRelation,m),_createClass(BelongsToRelation,[{key:"getForeignKey",value:function getForeignKey(e){return A.get(e,this.foreignKey)}},{key:"_setForeignKey",value:function _setForeignKey(e,t){A.set(e,this.foreignKey,A.get(t,this.getRelation().idAttribute))}},{key:"findExistingLinksFor",value:function findExistingLinksFor(e){if(e){var t=A.get(e,this.foreignKey);return null!=t?this.relatedCollection.get(t):void 0}}},{key:"isRequiresParentId",value:function isRequiresParentId(){return!0}},{key:"createParentRecord",value:function createParentRecord(t,e){var n=this,r=this.getLocalField(t);return this.createLinked(r,e).then(function(e){n.setForeignKey(t,e)})}},{key:"createChildRecord",value:function createChildRecord(){throw new Error('"BelongsTo" relation does not support child creation as it cannot have children.')}}]),BelongsToRelation}();Y.TYPE_NAME="belongsTo";var X=function(){function HasManyRelation(){return _classCallCheck(this,HasManyRelation),_possibleConstructorReturn(this,_getPrototypeOf(HasManyRelation).apply(this,arguments))}return _inherits(HasManyRelation,m),_createClass(HasManyRelation,[{key:"validateOptions",value:function validateOptions(e,t){_get(_getPrototypeOf(HasManyRelation.prototype),"validateOptions",this).call(this,e,t);var n=t.localKeys,r=t.foreignKeys,i=t.foreignKey;if(!i&&!n&&!r)throw A.err("new Relation","opts.<foreignKey|localKeys|foreignKeys>")(400,"string",i)}},{key:"canFindLinkFor",value:function canFindLinkFor(e){return!!(this.foreignKey||this.foreignKeys||this.localKeys&&A.get(e,this.localKeys))}},{key:"linkRecord",value:function linkRecord(n,e){var r=this,i=this.relatedCollection,o=this.canAutoAddLinks,a=this.foreignKey,s=this.relatedCollection.unsaved();return e.map(function(e){var t=i.recordId(e);return(void 0===t&&-1===s.indexOf(e)||e!==i.get(t))&&(a&&r.setForeignKey(n,e),o&&(e=i.add(e))),e})}},{key:"findExistingLinksFor",value:function findExistingLinksFor(e){var t,n=A.get(e,this.mapper.idAttribute),r=this.localKeys?A.get(e,this.localKeys):null;if(void 0!==n&&this.foreignKey?t=this.findExistingLinksByForeignKey(n):this.localKeys&&r?t=this.findExistingLinksByLocalKeys(r):void 0!==n&&this.foreignKeys&&(t=this.findExistingLinksByForeignKeys(n)),null!==t&&void 0!==t&&t.length)return t}},{key:"findExistingLinksByLocalKeys",value:function findExistingLinksByLocalKeys(e){return this.relatedCollection.filter({where:_defineProperty({},this.relatedCollection.mapper.idAttribute,{in:e})})}},{key:"findExistingLinksByForeignKeys",value:function findExistingLinksByForeignKeys(e){return this.relatedCollection.filter({where:_defineProperty({},this.foreignKeys,{contains:e})})}},{key:"isRequiresParentId",value:function isRequiresParentId(){return!!this.localKeys&&0<this.localKeys.length}},{key:"isRequiresChildId",value:function isRequiresChildId(){return!!this.foreignKey}},{key:"createParentRecord",value:function createParentRecord(t,e){var n=this,r=this.getLocalField(t),i=this.getRelation().idAttribute;return this.createLinked(r,e).then(function(e){A.set(t,n.localKeys,e.map(function(e){return A.get(e,i)}))})}},{key:"createLinked",value:function createLinked(e,t){return this.getRelation().createMany(e,t)}}]),HasManyRelation}();X.TYPE_NAME="hasMany";var Z=function(){function HasOneRelation(){return _classCallCheck(this,HasOneRelation),_possibleConstructorReturn(this,_getPrototypeOf(HasOneRelation).apply(this,arguments))}return _inherits(HasOneRelation,m),_createClass(HasOneRelation,[{key:"findExistingLinksFor",value:function findExistingLinksFor(e,t){var n=A.get(t,e.idAttribute),r=this.findExistingLinksByForeignKey(n);if(null!==r&&void 0!==r&&r.length)return r[0]}},{key:"isRequiresChildId",value:function isRequiresChildId(){return!0}}]),HasOneRelation}();function belongsTo(t,n){return function(e){m.belongsTo(t,n).assignTo(e)}}function hasMany(t,n){return function(e){m.hasMany(t,n).assignTo(e)}}function hasOne(t,n){return function(e){m.hasOne(t,n).assignTo(e)}}Z.TYPE_NAME="hasOne",[Y,X,Z].forEach(function(n){m[n.TYPE_NAME]=function(e,t){return new n(e,t)}});var ee="Mapper",te=["beforeCreate","beforeCreateMany"],ne=["beforeCreate","beforeCreateMany","beforeUpdate","beforeUpdateAll","beforeUpdateMany"];function makeNotify(f){return function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=n[n.length-f],o=i.op;if(this.dbg.apply(this,[o].concat(n)),-1!==te.indexOf(o)&&!1!==i.applyDefaults){var a=this.getSchema();if(null!==a&&void 0!==a&&a.applyDefaults){var s=n[0];A.isArray(s)||(s=[s]),s.forEach(function(e){a.applyDefaults(e)})}}if(-1!==ne.indexOf(o)&&!i.noValidate){var l=i.existingOnly;0===o.indexOf("beforeUpdate")&&void 0===i.existingOnly&&(i.existingOnly=!0);var u=this.validate(n["beforeUpdate"===o?1:0],A.pick(i,["existingOnly"]));if(i.existingOnly=l,u){var c=new T("validation failed");return c.errors=u,A.reject(c)}}(i.notify||void 0===i.notify&&this.notify)&&setTimeout(function(){e.emit.apply(e,[o].concat(n))})}}function Ia(e,t,n){var r=this._completedQueries[e][t];return A.isFunction(r)?r(e,t,n):r}var re=makeNotify(1),ie=makeNotify(2),oe={count:{defaults:[{},{}],skip:!0,types:[]},destroy:{defaults:[{},{}],skip:!0,types:[]},destroyAll:{defaults:[{},{}],skip:!0,types:[]},find:{defaults:[void 0,{}],types:[]},findAll:{defaults:[{},{}],types:[]},sum:{defaults:[void 0,{},{}],skip:!0,types:[]},update:{adapterArgs:function adapterArgs(e,t,n,r){return[t,e.toJSON(n,r),r]},beforeAssign:1,defaults:[void 0,{},{}],types:[]},updateAll:{adapterArgs:function adapterArgs(e,t,n,r){return[e.toJSON(t,r),n,r]},beforeAssign:0,defaults:[{},{},{}],types:[]},updateMany:{adapterArgs:function adapterArgs(t,e,n){return[e.map(function(e){return t.toJSON(e,n)}),n]},beforeAssign:0,defaults:[[],{}],types:[]}},ae={_adapters:{},applyDefaults:!0,applySchema:!0,defaultAdapter:"http",idAttribute:"id",keepChangeHistory:!0,notify:!0,noValidate:!1,raw:!1,validateOnSet:!0},se=function(){function Mapper(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(_classCallCheck(this,Mapper),(e=_possibleConstructorReturn(this,_getPrototypeOf(Mapper).call(this))).lifecycleMethods=oe,e.afterCount=ie,e.afterCreate=ie,e.afterCreateMany=ie,e.afterDestroy=ie,e.afterDestroyAll=ie,e.afterFind=ie,e.afterFindAll=ie,e.afterSum=ie,e.afterUpdate=ie,e.afterUpdateAll=ie,e.afterUpdateMany=ie,e.beforeCreate=re,e.beforeCreateMany=re,e.beforeCount=re,e.beforeDestroy=re,e.beforeDestroyAll=re,e.beforeFind=re,e.beforeFindAll=re,e.beforeSum=re,e.beforeUpdate=re,e.beforeUpdateAll=re,e.beforeUpdateMany=re,A.fillIn(_assertThisInitialized(e),t),A.fillIn(_assertThisInitialized(e),A.copy(ae)),!e.name)throw A.err("new ".concat(ee),"opts.name")(400,"string",e.name);return e.schema&&(e.schema.type=e.schema.type||"object",e.schema instanceof z||(e.schema=new z(e.schema||{type:"object"}))),void 0===e.recordClass&&(e.recordClass=function(){function TiedRecord(){return _classCallCheck(this,TiedRecord),_possibleConstructorReturn(this,_getPrototypeOf(TiedRecord).apply(this,arguments))}return _inherits(TiedRecord,I),TiedRecord}()),e.recordClass&&(e.recordClass.mapper=_assertThisInitialized(e),A.isObject(e.methods)&&A.addHiddenPropsToTarget(e.recordClass.prototype,e.methods),I.prototype.isPrototypeOf(Object.create(e.recordClass.prototype))&&e.schema&&e.schema.apply&&e.applySchema&&e.schema.apply(e.recordClass.prototype)),e}return _inherits(Mapper,o),_createClass(Mapper,[{key:"_end",value:function _end(e,t,n){var r=2<arguments.length&&void 0!==n&&n;if(t.raw&&A._(e,t),r)return e;var i=t.raw?e.data:e;return i&&A.isFunction(this.wrap)&&(i=this.wrap(i,t),t.raw?e.data=i:e=i),e}},{key:"belongsTo",value:function belongsTo$1(e,t){return belongsTo(e,t)(this)}},{key:"count",value:function count(e,t){return this.crud("count",e,t)}},{key:"create",value:function create(e,t){var n=this,r=0<arguments.length&&void 0!==e?e:{},i=1<arguments.length&&void 0!==t?t:{},o=r,a={},s={};return A._(i,this),i.adapter=this.getAdapterName(i),i.op="beforeCreate",this._runHook(i.op,r,i).then(function(e){return i.with=i.with||[],n._createParentRecordIfRequired(e,i)}).then(function(e){a=e}).then(function(){return i.op="create",n._invokeAdapterMethod(i.op,r,i)}).then(function(e){s=e}).then(function(){var e=i.raw?s.data:s;return n._createOrAssignChildRecordIfRequired(e,{opts:i,parentRelationMap:a,originalProps:r})}).then(function(e){return n._commitChanges(o,e)}).then(function(e){i.raw?s.data=e:s=e;var t=n._end(s,i);return i.op="afterCreate",n._runHook(i.op,r,i,t)})}},{key:"_commitChanges",value:function _commitChanges(e,n){var r=this;return A.isArray(e)?e.map(function(e,t){return r._commitChanges(e,n[t])}):(A.set(e,n,{silent:!0}),A.isFunction(e.commit)&&e.commit(),e)}},{key:"createInstance",value:function createInstance(e,t){return this.createRecord(e,t)}},{key:"_createParentRecordIfRequired",value:function _createParentRecordIfRequired(n,e){var r=[],i=[];return A.forEachRelation(this,e,function(e,t){e.isRequiresParentId()&&e.getLocalField(n)&&(t.raw=!1,i.push(e),r.push(e.createParentRecord(n,t)))}),Promise.all(r).then(function(r){return i.reduce(function(e,t,n){return t.setLocalField(e,r[n]),e},{})})}},{key:"_createOrAssignChildRecordIfRequired",value:function _createOrAssignChildRecordIfRequired(i,o){var a=[];return A.forEachRelation(this,o.opts,function(e,t){var n=e.getLocalField(o.originalProps);if(n)if(t.raw=!1,e.isRequiresChildId())a.push(e.createChildRecord(i,n,t));else if(e.isRequiresParentId()){var r=e.getLocalField(o.parentRelationMap);r&&e.setLocalField(i,r)}}),Promise.all(a).then(function(){return i})}},{key:"createMany",value:function createMany(e,t){var n,u=this,r=0<arguments.length&&void 0!==e?e:[],i=1<arguments.length&&void 0!==t?t:{},c=r;return A._(i,this),i.adapter=this.getAdapterName(i),i.op="beforeCreateMany",this._runHook(i.op,r,i).then(function(a){var s={};i.with=i.with||[];var l=[];return A.forEachRelation(u,i,function(r,e){var t=a.map(function(e){return r.getLocalField(e)}).filter(Boolean);r.type===O&&t.length===a.length&&(e.raw=!1,l.push(r.createLinked(t,e).then(function(n){a.forEach(function(e,t){return r.setForeignKey(e,n[t])})}).then(function(e){r.setLocalField(s,e)})))}),Promise.all(l).then(function(){return i.op="createMany",u._invokeAdapterMethod(i.op,a,i)}).then(function(e){n=e}).then(function(){var o=i.raw?n.data:n;return l=[],A.forEachRelation(u,i,function(r,e){var n=a.map(function(e){return r.getLocalField(e)}).filter(Boolean);if(n.length===a.length){e.raw=!1;var t,i=r.getLocalField(s);r.type===C?u.log("warn","deep createMany of hasMany type not supported!"):r.type===R?(o.forEach(function(e,t){r.setForeignKey(e,n[t])}),t=r.getRelation().createMany(n,e).then(function(n){o.forEach(function(e,t){r.setLocalField(e,n[t])})})):r.type===O&&i&&i.length===o.length&&o.forEach(function(e,t){r.setLocalField(e,i[t])}),t&&l.push(t)}}),Promise.all(l).then(function(){return u._commitChanges(c,o)})})}).then(function(e){i.raw?n.data=e:n=e;var t=u._end(n,i);return i.op="afterCreateMany",u._runHook(i.op,e,i,t)})}},{key:"createRecord",value:function createRecord(e,t){var n=this,r=0<arguments.length&&void 0!==e?e:{},i=1<arguments.length?t:void 0;if(A.isArray(r))return r.map(function(e){return n.createRecord(e,i)});if(!A.isObject(r))throw A.err("".concat(ee,"#createRecord"),"props")(400,"array or object",r);this.relationList&&this.relationList.forEach(function(e){e.ensureLinkedDataHasProperType(r,i)});var o=this.recordClass;return!o||r instanceof o?r:new o(r,i)}},{key:"crud",value:function crud(n){for(var r=this,e=arguments.length,i=new Array(1<e?e-1:0),t=1;t<e;t++)i[t-1]=arguments[t];var o=this.lifecycleMethods[n];if(!o)throw A.err("".concat(ee,"#crud"),n)(404,"method");var a,s="".concat(n.charAt(0).toUpperCase()).concat(n.substr(1)),l="before".concat(s),u="after".concat(s);o.defaults.forEach(function(e,t){void 0===i[t]&&(i[t]=A.copy(e))});var c=i[i.length-1];A._(c,this);var f=c.adapter=this.getAdapterName(c);return a=c.op=l,A.resolve(this[a].apply(this,_toConsumableArray(i))).then(function(e){var t;return void 0!==i[o.beforeAssign]&&(i[o.beforeAssign]=void 0===e?i[o.beforeAssign]:e),a=c.op=n,i=o.adapterArgs?o.adapterArgs.apply(o,[r].concat(_toConsumableArray(i))):i,r.dbg.apply(r,[a].concat(_toConsumableArray(i))),A.resolve((t=r.getAdapter(f))[a].apply(t,[r].concat(_toConsumableArray(i))))}).then(function(t){var e=/find/.test(a)||c.noValidate,n=Object.assign({},c,{noValidate:e});return t=r._end(t,n,!!o.skip),i.push(t),a=c.op=u,A.resolve(r[a].apply(r,_toConsumableArray(i))).then(function(e){return void 0===e?t:e})})}},{key:"destroy",value:function destroy(e,t){return this.crud("destroy",e,t)}},{key:"destroyAll",value:function destroyAll(e,t){return this.crud("destroyAll",e,t)}},{key:"find",value:function find(e,t){return this.crud("find",e,t)}},{key:"findAll",value:function findAll(e,t){return this.crud("findAll",e,t)}},{key:"getAdapter",value:function getAdapter(e){this.dbg("getAdapter","name:",e);var t=this.getAdapterName(e);if(!t)throw A.err("".concat(ee,"#getAdapter"),"name")(400,"string",e);return this.getAdapters()[t]}},{key:"getAdapterName",value:function getAdapterName(e){var t=0<arguments.length&&void 0!==e?e:{};return A.isString(t)&&(t={adapter:t}),t.adapter||t.defaultAdapter}},{key:"getAdapters",value:function getAdapters(){return this._adapters}},{key:"getSchema",value:function getSchema(){return this.schema}},{key:"hasMany",value:function hasMany$1(e,t){return hasMany(e,t)(this)}},{key:"hasOne",value:function hasOne$1(e,t){return hasOne(e,t)(this)}},{key:"is",value:function is(e){var t=this.recordClass;return!!t&&e instanceof t}},{key:"registerAdapter",value:function registerAdapter(e,t,n){var r=2<arguments.length&&void 0!==n?n:{};this.getAdapters()[e]=t,!0!==r&&!r.default||(this.defaultAdapter=e)}},{key:"_runHook",value:function _runHook(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=0===e.indexOf("after")?n.length-1:0;return A.resolve(this[e].apply(this,n)).then(function(e){return void 0===e?n[i]:e})}},{key:"_invokeAdapterMethod",value:function _invokeAdapterMethod(e,t,n){var r,i=this,o={with:n.pass||[]};return this.dbg(n.op,t,n),r=A.isArray(t)?t.map(function(e){return i.toJSON(e,o)}):this.toJSON(t,o),this.getAdapter(n.adapter)[e](this,r,n)}},{key:"sum",value:function sum(e,t,n){return this.crud("sum",e,t,n)}},{key:"toJSON",value:function toJSON(e,t){var r,n=this,i=1<arguments.length&&void 0!==t?t:{};if(A.isArray(e))return e.map(function(e){return n.toJSON(e,i)});r=e;var o=(this?this.relationFields:[])||[],a={};if(this&&this.schema)a=this.schema.pick(r);else for(var s in r)-1===o.indexOf(s)&&(a[s]=A.plainCopy(r[s]));return this&&i.withAll&&(i.with=o.slice()),this&&i.with&&(A.isString(i.with)&&(i.with=[i.with]),A.forEachRelation(this,i,function(t,n){var e=t.getLocalField(r);e&&(A.isArray(e)?t.setLocalField(a,e.map(function(e){return t.getRelation().toJSON(e,n)})):t.setLocalField(a,t.getRelation().toJSON(e,n)))})),a}},{key:"update",value:function update(e,t,n){return this.crud("update",e,t,n)}},{key:"updateAll",value:function updateAll(e,t,n){return this.crud("updateAll",e,t,n)}},{key:"updateMany",value:function updateMany(e,t){return this.crud("updateMany",e,t)}},{key:"validate",value:function validate(e,t){var n=1<arguments.length&&void 0!==t?t:{},r=this.getSchema();if(r){var i=A.pick(n,["existingOnly"]);if(A.isArray(e)){var o=e.map(function(e){return r.validate(e,A.pick(i,["existingOnly"]))});return o.some(Boolean)?o:void 0}return r.validate(e,i)}}},{key:"wrap",value:function wrap(e,t){return this.createRecord(e,t)}},{key:"defineRelations",value:function defineRelations(){var i=this;A.forOwn(this.relations,function(e,r){A.forOwn(e,function(e,n){A.isObject(e)&&(e=[e]),e.forEach(function(e){var t=i.datastore.getMapperByName(n)||n;if(e.getRelation=function(){return i.datastore.getMapper(n)},"function"!=typeof m[r])throw A.err(ee,"defineRelations")(400,"relation type (hasOne, hasMany, etc)",r,!0);i[r](t,e)})})})}}]),Mapper}(),le="Container",ue=["count","create","createMany","createRecord","destroy","destroyAll","find","findAll","getSchema","is","sum","toJSON","update","updateAll","updateMany","validate"],ce=function(){function Container(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,Container),e=_possibleConstructorReturn(this,_getPrototypeOf(Container).call(this)),Object.defineProperties(_assertThisInitialized(e),{_adapters:{value:{}},_mappers:{value:{}},mapperClass:{value:void 0,writable:!0}}),A.fillIn(_assertThisInitialized(e),t),e.mapperDefaults=e.mapperDefaults||{},e.mapperClass=e.mapperClass||se,e}return _inherits(Container,o),_createClass(Container,[{key:"_onMapperEvent",value:function _onMapperEvent(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.shift();this.emit.apply(this,[i,e].concat(n))}},{key:"as",value:function as(i){var e={},o=this;return ue.forEach(function(r){e[r]={writable:!0,value:function value(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[r].apply(o,[i].concat(t))}}}),e.getMapper={writable:!0,value:function value(){return o.getMapper(i)}},Object.create(this,e)}},{key:"defineMapper",value:function defineMapper(r,e){var i=this;if(A.isObject(r)&&(r=(e=r).name),!A.isString(r))throw A.err("".concat(le,"#defineMapper"),"name")(400,"string",r);(e=e||{}).name=r,e.relations=e.relations||{};var t=e.mapperClass||this.mapperClass;delete e.mapperClass,A.fillIn(e,this.mapperDefaults);var n=this._mappers[r]=new t(e);return n.relations=n.relations||{},n.name=r,n._adapters=this.getAdapters(),n.datastore=this,n.on("all",function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i._onMapperEvent.apply(i,[r].concat(t))}),n.defineRelations(),n}},{key:"defineResource",value:function defineResource(e,t){return console.warn("DEPRECATED: defineResource is deprecated, use defineMapper instead"),this.defineMapper(e,t)}},{key:"getAdapter",value:function getAdapter(e){var t=this.getAdapterName(e);if(!t)throw A.err("".concat(le,"#getAdapter"),"name")(400,"string",e);return this.getAdapters()[t]}},{key:"getAdapterName",value:function getAdapterName(e){var t=0<arguments.length&&void 0!==e?e:{};return A.isString(t)&&(t={adapter:t}),t.adapter||this.mapperDefaults.defaultAdapter}},{key:"getAdapters",value:function getAdapters(){return this._adapters}},{key:"getMapper",value:function getMapper(e){var t=this.getMapperByName(e);if(!t)throw A.err("".concat(le,"#getMapper"),e)(404,"mapper");return t}},{key:"getMapperByName",value:function getMapperByName(e){return this._mappers[e]}},{key:"registerAdapter",value:function registerAdapter(t,e,n){var r=2<arguments.length&&void 0!==n?n:{};this.getAdapters()[t]=e,!0!==r&&!r.default||(this.mapperDefaults.defaultAdapter=t,A.forOwn(this._mappers,function(e){e.defaultAdapter=t}))}},{key:"count",value:function count(e,t,n){return this.getMapper(e).count(t,n)}},{key:"create",value:function create(e,t,n){return this.getMapper(e).create(t,n)}},{key:"createMany",value:function createMany(e,t,n){return this.getMapper(e).createMany(t,n)}},{key:"createRecord",value:function createRecord(e,t,n){return this.getMapper(e).createRecord(t,n)}},{key:"destroy",value:function destroy(e,t,n){return this.getMapper(e).destroy(t,n)}},{key:"destroyAll",value:function destroyAll(e,t,n){return this.getMapper(e).destroyAll(t,n)}},{key:"find",value:function find(e,t,n){return this.getMapper(e).find(t,n)}},{key:"findAll",value:function findAll(e,t,n){return this.getMapper(e).findAll(t,n)}},{key:"getSchema",value:function getSchema(e){return this.getMapper(e).getSchema()}},{key:"is",value:function is(e,t){return this.getMapper(e).is(t)}},{key:"sum",value:function sum(e,t,n,r){return this.getMapper(e).sum(t,n,r)}},{key:"toJSON",value:function toJSON(e,t,n){return this.getMapper(e).toJSON(t,n)}},{key:"update",value:function update(e,t,n,r){return this.getMapper(e).update(t,n,r)}},{key:"updateAll",value:function updateAll(e,t,n,r){return this.getMapper(e).updateAll(t,n,r)}},{key:"updateMany",value:function updateMany(e,t,n){return this.getMapper(e).updateMany(t,n)}},{key:"validate",value:function validate(e,t,n){return this.getMapper(e).validate(t,n)}}]),Container}(),fe=["add","between","createIndex","filter","get","getAll","prune","query","toJSON","unsaved"],de=["addToCache","cachedFind","cachedFindAll","cacheFind","cacheFindAll","hashQuery"],he={usePendingFind:!0,usePendingFindAll:!0},pe=function(){function SimpleStore(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,SimpleStore),(e=_possibleConstructorReturn(this,_getPrototypeOf(SimpleStore).call(this,Object.assign(Object.assign({},he),t))))._collections={},e._completedQueries={},e._pendingQueries={},e.cachedFind=Ia,e.cachedFindAll=Ia,e.collectionClass=e.collectionClass||L,e}return _inherits(SimpleStore,ce),_createClass(SimpleStore,[{key:"_end",value:function _end(e,t,n){var r=n.raw?t.data:t;return r&&A.isFunction(this.addToCache)&&(r=this.addToCache(e,r,n),n.raw?t.data=r:t=r),t}},{key:"_onCollectionEvent",value:function _onCollectionEvent(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var i=n.shift();this.emit.apply(this,[i,e].concat(n))}},{key:"addToCache",value:function addToCache(e,t,n){return this.getCollection(e).add(t,n)}},{key:"as",value:function as(i){var e={},o=this;return de.concat(ue).concat(fe).forEach(function(r){e[r]={writable:!0,value:function value(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o[r].apply(o,[i].concat(t))}}}),e.getMapper={writable:!0,value:function value(){return o.getMapper(i)}},e.getCollection={writable:!0,value:function value(){return o.getCollection(i)}},Object.create(this,e)}},{key:"cacheFind",value:function cacheFind(e,t,n){var r=this;this._completedQueries[e][n]=function(e,t,n){return r.get(e,t)}}},{key:"cacheFindAll",value:function cacheFindAll(e,t,n){var r=this;this._completedQueries[e][n]=function(e,t,n){return r.filter(e,A.fromJson(t))}}},{key:"clear",value:function clear(){var n=this,r={};return A.forOwn(this._collections,function(e,t){r[t]=e.removeAll(),n._completedQueries[t]={}}),r}},{key:"create",value:function create(t,e,n){var r=this,i=2<arguments.length&&void 0!==n?n:{};return _get(_getPrototypeOf(SimpleStore.prototype),"create",this).call(this,t,e,i).then(function(e){return r._end(t,e,i)})}},{key:"createMany",value:function createMany(t,e,n){var r=this,i=2<arguments.length&&void 0!==n?n:{};return _get(_getPrototypeOf(SimpleStore.prototype),"createMany",this).call(this,t,e,i).then(function(e){return r._end(t,e,i)})}},{key:"defineMapper",value:function defineMapper(r,e){var t=1<arguments.length&&void 0!==e?e:{},i=this,n=_get(_getPrototypeOf(SimpleStore.prototype),"defineMapper",this).call(this,r,t);i._pendingQueries[r]={},i._completedQueries[r]={},n.relationList||Object.defineProperty(n,"relationList",{value:[]});var o={_added:{},datastore:this,mapper:n};t&&"onConflict"in t&&(o.onConflict=t.onConflict);var a=i._collections[r]=new i.collectionClass(null,o),s=(n.schema||{}).properties||{};return A.forOwn(s,function(e,t){e.indexed&&a.createIndex(t)}),a.createIndex("addedTimestamps",["$"],{fieldGetter:function fieldGetter(e){return a._added[a.recordId(e)]}}),a.on("all",function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];i._onCollectionEvent.apply(i,[r].concat(t))}),n}},{key:"destroy",value:function destroy(n,r,e){var i=this,o=2<arguments.length&&void 0!==e?e:{};return _get(_getPrototypeOf(SimpleStore.prototype),"destroy",this).call(this,n,r,o).then(function(e){var t=i.getCollection(n).remove(r,o);return o.raw?e.data=t:e=t,delete i._pendingQueries[n][r],delete i._completedQueries[n][r],e})}},{key:"destroyAll",value:function destroyAll(r,i,e){var o=this,a=2<arguments.length&&void 0!==e?e:{};return _get(_getPrototypeOf(SimpleStore.prototype),"destroyAll",this).call(this,r,i,a).then(function(e){var t=o.getCollection(r).removeAll(i,a);a.raw?e.data=t:e=t;var n=o.hashQuery(r,i,a);return delete o._pendingQueries[r][n],delete o._completedQueries[r][n],e})}},{key:"eject",value:function eject(e,t,n){return console.warn('DEPRECATED: "eject" is deprecated, use "remove" instead'),this.remove(e,t,n)}},{key:"ejectAll",value:function ejectAll(e,t,n){return console.warn('DEPRECATED: "ejectAll" is deprecated, use "removeAll" instead'),this.removeAll(e,t,n)}},{key:"find",value:function find(t,n,e){var r=this,i=2<arguments.length&&void 0!==e?e:{},o=this.getMapper(t),a=this._pendingQueries[t][n],s=void 0===i.usePendingFind?this.usePendingFind:i.usePendingFind;if(A._(i,o),a&&(A.isFunction(s)?s.call(this,t,n,i):s))return a;var l=this.cachedFind(t,n,i);return!i.force&&l?A.resolve(l):(this._pendingQueries[t][n]=_get(_getPrototypeOf(SimpleStore.prototype),"find",this).call(this,t,n,i)).then(function(e){return delete r._pendingQueries[t][n],e=r._end(t,e,i),r.cacheFind(t,e,n,i),e},function(e){return delete r._pendingQueries[t][n],A.reject(e)})}},{key:"findAll",value:function findAll(t,e,n){var r=this,i=2<arguments.length&&void 0!==n?n:{},o=this.getMapper(t),a=this.hashQuery(t,e,i),s=this._pendingQueries[t][a],l=void 0===i.usePendingFindAll?this.usePendingFindAll:i.usePendingFindAll;if(A._(i,o),s&&(A.isFunction(l)?l.call(this,t,e,i):l))return s;var u=this.cachedFindAll(t,a,i);return!i.force&&u?A.resolve(u):(this._pendingQueries[t][a]=_get(_getPrototypeOf(SimpleStore.prototype),"findAll",this).call(this,t,e,i)).then(function(e){return delete r._pendingQueries[t][a],e=r._end(t,e,i),r.cacheFindAll(t,e,a,i),e},function(e){return delete r._pendingQueries[t][a],A.reject(e)})}},{key:"getCollection",value:function getCollection(e){var t=this._collections[e];if(!t)throw A.err("".concat("SimpleStore","#getCollection"),e)(404,"collection");return t}},{key:"hashQuery",value:function hashQuery(e,t){return A.toJson(t||{})}},{key:"inject",value:function inject(e,t,n){return console.warn('DEPRECATED: "inject" is deprecated, use "add" instead'),this.add(e,t,n)}},{key:"remove",value:function remove(e,t,n){var r=this.getCollection(e).remove(t,n);return r&&this.removeRelated(e,[r],n),r}},{key:"removeAll",value:function removeAll(e,t,n){t&&Object.keys(t).length?this._completedQueries[e][this.hashQuery(e,t,n)]=void 0:this._completedQueries[e]={};var r=this.getCollection(e).removeAll(t,n);return r.length&&this.removeRelated(e,r,n),r}},{key:"removeRelated",value:function removeRelated(e,t,n){var o=this;A.isArray(t)||(t=[t]),A.forEachRelation(this.getMapper(e),n,function(r,i){t.forEach(function(e){var t,n;if(!r.foreignKey||r.type!==R&&r.type!==C?r.type===C&&r.localKeys?n={where:_defineProperty({},r.getRelation().idAttribute,{in:A.get(e,r.localKeys)})}:r.type===C&&r.foreignKeys?n={where:_defineProperty({},r.foreignKeys,{contains:r.getForeignKey(e)})}:r.type===O&&(t=o.remove(r.relation,r.getForeignKey(e),i)):n=_defineProperty({},r.foreignKey,r.getForeignKey(e)),n&&(t=o.removeAll(r.relation,n,i)),t){if(A.isArray(t)&&!t.length)return;r.type===R&&(t=t[0]),r.setLocalField(e,t)}})})}},{key:"update",value:function update(t,e,n,r){var i=this,o=3<arguments.length&&void 0!==r?r:{};return _get(_getPrototypeOf(SimpleStore.prototype),"update",this).call(this,t,e,n,o).then(function(e){return i._end(t,e,o)})}},{key:"updateAll",value:function updateAll(t,e,n,r){var i=this,o=3<arguments.length&&void 0!==r?r:{};return _get(_getPrototypeOf(SimpleStore.prototype),"updateAll",this).call(this,t,e,n,o).then(function(e){return i._end(t,e,o)})}},{key:"updateMany",value:function updateMany(t,e,n){var r=this,i=2<arguments.length&&void 0!==n?n:{};return _get(_getPrototypeOf(SimpleStore.prototype),"updateMany",this).call(this,t,e,i).then(function(e){return r._end(t,e,i)})}},{key:"add",value:function add(e,t,n){return this.getCollection(e).add(t,n)}},{key:"between",value:function between(e,t,n,r){return this.getCollection(e).between(t,n,r)}},{key:"createIndex",value:function createIndex(e,t,n,r){return this.getCollection(e).createIndex(t,n,r)}},{key:"filter",value:function filter(e,t,n){return this.getCollection(e).filter(t,n)}},{key:"get",value:function get(e,t){return this.getCollection(e).get(t)}},{key:"getAll",value:function getAll(e){for(var t,n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return(t=this.getCollection(e)).getAll.apply(t,r)}},{key:"prune",value:function prune(e,t){return this.getCollection(e).prune(t)}},{key:"query",value:function query(e){return this.getCollection(e).query()}},{key:"toJSON",value:function toJSON(e,t){return this.getCollection(e).toJSON(t)}},{key:"unsaved",value:function unsaved(e,t){return this.getCollection(e).unsaved(t)}}]),SimpleStore}(),ve=function(){function LinkedCollection(e,t){var n;if(_classCallCheck(this,LinkedCollection),!(n=_possibleConstructorReturn(this,_getPrototypeOf(LinkedCollection).call(this,e,t))).datastore)throw A.err("new ".concat("LinkedCollection"),"opts.datastore")(400,"DataStore",n.datastore);return n}return _inherits(LinkedCollection,L),_createClass(LinkedCollection,[{key:"_addMeta",value:function _addMeta(e,t){this._added[this.recordId(e)]=t,A.isFunction(e._set)&&e._set("$",t)}},{key:"_clearMeta",value:function _clearMeta(e){delete this._added[this.recordId(e)],A.isFunction(e._set)&&e._set("$")}},{key:"_onRecordEvent",value:function _onRecordEvent(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];L.prototype._onRecordEvent.apply(this,t);var r=t[0];A.isString(r)&&0===r.indexOf("change")&&this.updateIndexes(t[1])}},{key:"add",value:function add(t,e){var n=this,r=this.mapper,i=(new Date).getTime(),o=A.isObject(t)&&!A.isArray(t);return o&&(t=[t]),t=_get(_getPrototypeOf(LinkedCollection.prototype),"add",this).call(this,t,e),r.relationList.length&&t.length&&r.relationList.forEach(function(e){e.addLinkedRecords(t)}),t.forEach(function(e){return n._addMeta(e,i)}),o?t[0]:t}},{key:"remove",value:function remove(e,t){var n=this.mapper,r=_get(_getPrototypeOf(LinkedCollection.prototype),"remove",this).call(this,e,t);return r&&this._clearMeta(r),n.relationList.length&&r&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,[r])}),r}},{key:"removeAll",value:function removeAll(e,t){var n=this.mapper,r=_get(_getPrototypeOf(LinkedCollection.prototype),"removeAll",this).call(this,e,t);return r.forEach(this._clearMeta,this),n.relationList.length&&r.length&&n.relationList.forEach(function(e){e.removeLinkedRecords(n,r)}),r}}]),LinkedCollection}(),ye={unlinkOnDestroy:!0,collectionClass:ve},ge=function(){function DataStore(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck(this,DataStore),_possibleConstructorReturn(this,_getPrototypeOf(DataStore).call(this,Object.assign(Object.assign({},ye),e)))}return _inherits(DataStore,pe),_createClass(DataStore,[{key:"defineMapper",value:function defineMapper(e,t){var k=this,_=_get(_getPrototypeOf(DataStore.prototype),"defineMapper",this).call(this,e,t),b=_.idAttribute,u=this.getCollection(e);return _.relationList.forEach(function(c){function _C(){return this._get(h)}var e,f=c.relation,d=c.localField,h="links.".concat(d),p=c.foreignKey,t=c.type,y={index:p};if(t===O){u.indexes[p]||u.createIndex(p),e={get:_C,set:function set(e){var t=this._get(h);if(e===t)return t;var n=A.get(this,b),r=c.getInverse(_);if(t&&r&&this.removeInverseRelation(t,n,r,b),e){var i=c.getRelation().idAttribute,o=A.get(e,i);void 0!==o&&this._get("$")&&(e=k.get(f,o)||e),w(this,d,e),v(this,p,o),u.updateIndex(this,y),r&&this.setupInverseRelation(e,n,r,b)}else w(this,d,void 0);return e}};var n=Object.getOwnPropertyDescriptor(_.recordClass.prototype,p),r=(n=n||{enumerable:!0}).get;n.get=function(){return r?r.call(this):this._get("props.".concat(p))};var l=n.set;n.set=function(e){var t=this;l&&l.call(this,e);var n=A.get(this,d),r=A.get(this,b),i=c.getInverse(_),o=n?A.get(n,c.getRelation().idAttribute):void 0;if(i&&n&&void 0!==o&&o!==e)if(i.type===R)w(n,i.localField,void 0);else if(i.type===C){var a=A.get(n,i.localField);void 0===r?A.remove(a,function(e){return e===t}):A.remove(a,function(e){return e===t||r===A.get(e,b)})}if(v(this,p,e),u.updateIndex(this,y),null==e)void 0!==o&&A.set(this,d,void 0);else if(this._get("$")){var s=k.get(f,e);s&&A.set(this,d,s)}},Object.defineProperty(_.recordClass.prototype,p,n)}else if(t===C){var g=c.localKeys,m=c.foreignKeys;k._collections[f]&&p&&!k.getCollection(f).indexes[p]&&k.getCollection(f).createIndex(p),e={get:function get(){return _C.call(this)||this._set(h,[]),_C.call(this)},set:function set(n){var i=this;n&&!A.isArray(n)&&(n=[n]);var r=A.get(this,b),o=c.getRelation().idAttribute,e=c.getInverse(_),a=e.localField,t=this._get(h)||[],s=[],l={};if(n&&n.forEach(function(t){var n=A.get(t,o),e=A.get(t,a);if(e&&e!==i){var r=A.get(e,d);void 0===n?A.remove(r,function(e){return e===t}):A.remove(r,function(e){return e===t||n===A.get(e,o)})}void 0!==n&&(i._get("$")&&(t=k.get(f,n)||t),l[n]=t),s.push(t)}),p)t.forEach(function(e){var t=A.get(e,o);(void 0!==t||-1!==s.indexOf(e))&&(void 0===t||t in l)||(n&&(v(e,p,void 0),k.getCollection(f).updateIndex(e,y)),w(e,a,void 0))}),s.forEach(function(e){v(e,p,r),k.getCollection(f).updateIndex(e,y),w(e,a,i)});else if(g){var u=s.map(function(e){return A.get(e,o)}).filter(function(e){return void 0!==e});A.set(this,g,u),e.foreignKeys&&(t.forEach(function(e){var t=A.get(e,o);if(void 0===t&&-1===s.indexOf(e)||void 0!==t&&!(t in l)){var n=A.get(e,a)||[];void 0===r?A.remove(n,function(e){return e===i}):A.remove(n,function(e){return e===i||r===A.get(e,b)})}}),s.forEach(function(e){var t=A.get(e,a);void 0===r?A.noDupeAdd(t,i,function(e){return e===i}):A.noDupeAdd(t,i,function(e){return e===i||r===A.get(e,b)})}))}else m&&(t.forEach(function(e){var t=A.get(e,m)||[];A.remove(t,function(e){return r===e});var n=A.get(e,a);void 0===r?A.remove(n,function(e){return e===i}):A.remove(n,function(e){return e===i||r===A.get(e,b)})}),s.forEach(function(e){var t=A.get(e,m)||[];A.noDupeAdd(t,r,function(e){return r===e});var n=A.get(e,a);void 0===r?A.noDupeAdd(n,i,function(e){return e===i}):A.noDupeAdd(n,i,function(e){return e===i||r===A.get(e,b)})}));return this._set(h,s),s}}}else t===R&&(k._collections[f]&&p&&!k.getCollection(f).indexes[p]&&k.getCollection(f).createIndex(p),e={get:_C,set:function set(e){var t=this._get(h);if(e===t)return t;var n=c.getInverse(_).localField;if(t&&(v(t,p,void 0),k.getCollection(f).updateIndex(t,y),w(t,n,void 0)),e){var r=A.get(e,c.getRelation().idAttribute);void 0!==r&&(e=k.get(f,r)||e),w(this,d,e),v(e,p,A.get(this,b)),k.getCollection(f).updateIndex(e,y),w(e,n,this)}else w(this,d,void 0);return e}});if(e){if(e.enumerable=void 0!==c.enumerable&&c.enumerable,c.get){var i=e.get;e.get=function(){var r=this;return c.get(c,this,function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return i.apply(r,t)})}}if(c.set){var o=e.set;e.set=function(t){var n=this;return c.set(c,this,t,function(e){return o.call(n,void 0===e?t:e)})}}Object.defineProperty(_.recordClass.prototype,d,e)}}),_}},{key:"destroy",value:function destroy(r,e,t){var i=this,o=2<arguments.length&&void 0!==t?t:{};return _get(_getPrototypeOf(DataStore.prototype),"destroy",this).call(this,r,e,o).then(function(e){var t;if((t=o.raw?e.data:e)&&i.unlinkOnDestroy){var n=A.plainCopy(o);n.withAll=!0,A.forEachRelation(i.getMapper(r),n,function(e){A.set(t,e.localField,void 0)})}return e})}},{key:"destroyAll",value:function destroyAll(r,e,t){var i=this,o=2<arguments.length&&void 0!==t?t:{};return _get(_getPrototypeOf(DataStore.prototype),"destroyAll",this).call(this,r,e,o).then(function(e){var n;if(null!==(n=o.raw?e.data:e)&&void 0!==n&&n.length&&i.unlinkOnDestroy){var t=A.plainCopy(o);t.withAll=!0,A.forEachRelation(i.getMapper(r),t,function(t){n.forEach(function(e){A.set(e,t.localField,void 0)})})}return e})}}]),DataStore}();e.Collection=L,e.Component=o,e.Container=ce,e.DataStore=ge,e.Index=P,e.LinkedCollection=ve,e.Mapper=se,e.Query=y,e.Record=I,e.Schema=z,e.Settable=x,e.SimpleStore=pe,e.belongsTo=belongsTo,e.belongsToType=O,e.hasMany=hasMany,e.hasManyType=C,e.hasOne=hasOne,e.hasOneType=R,e.utils=A,e.version={beta:4,full:"4.0.0-beta.4",major:4,minor:0,patch:0},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=js-data.min.map